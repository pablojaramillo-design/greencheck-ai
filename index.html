<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GreenCheck - An√°lisis Cr√≠tico de Greenwashing</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/color-thief/2.3.0/color-thief.umd.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Sans:wght@400;500;600;700&family=IBM+Plex+Serif:wght@400;600;700&display=swap" rel="stylesheet">
    
    <style>
        :root {
            --primary: #047857;
            --primary-dark: #065f46;
            --secondary: #dc2626;
        }
        
        body {
            font-family: 'IBM Plex Sans', sans-serif;
            background-color: #f9fafb;
            color: #111827;
        }
        
        h1, h2, h3, h4 {
            font-family: 'IBM Plex Serif', serif;
        }
        
        .card {
            background: white;
            border-radius: 12px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            padding: 1.5rem;
            margin-bottom: 1.5rem;
        }
        
        .btn-primary {
            background-color: var(--primary);
            color: white;
            padding: 0.75rem 1.5rem;
            border-radius: 8px;
            font-weight: 600;
            border: none;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .btn-primary:hover {
            background-color: var(--primary-dark);
            transform: translateY(-1px);
        }
        
        .btn-secondary {
            background-color: #e5e7eb;
            color: #111827;
            padding: 0.75rem 1.5rem;
            border-radius: 8px;
            font-weight: 600;
            border: none;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .btn-secondary:hover {
            background-color: #d1d5db;
        }
        
        .hidden {
            display: none !important;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
        }
        
        th, td {
            padding: 0.75rem;
            text-align: left;
            border-bottom: 1px solid #e5e7eb;
        }
        
        th {
            background-color: #f3f4f6;
            font-weight: 600;
        }
        
        .spinner {
            border: 3px solid #f3f4f6;
            border-top: 3px solid var(--primary);
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div id="app" class="max-w-5xl mx-auto p-4 md:p-8">
        
        <!-- PANTALLA 1: LANDING -->
        <div id="landing-view">
            <div class="text-center mb-12">
                <h1 class="text-5xl md:text-6xl font-bold text-transparent bg-clip-text bg-gradient-to-r from-green-700 to-emerald-600 mb-6">
                    GreenCheck
                </h1>
                <p class="text-xl text-gray-700 max-w-3xl mx-auto leading-relaxed">
                    Herramienta web que analiza anuncios de veh√≠culos el√©ctricos y estima su nivel de greenwashing a partir de evidencia visual y textual.
                </p>
            </div>

            <div class="card">
                <h2 class="text-2xl font-bold text-gray-900 mb-4 flex items-center">
                    <svg class="w-6 h-6 mr-2 text-red-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path>
                    </svg>
                    ¬øPor qu√© es importante?
                </h2>
                <div class="text-gray-700 space-y-4 leading-relaxed">
                    <p>El desarrollo de tecnolog√≠as llamadas "verdes" no est√° exento de profundas contradicciones √©ticas y ambientales. Mientras el tri√°ngulo del litio (Argentina, Chile y Bolivia) se convierte en un epicentro de extracci√≥n intensiva para abastecer la industria de bater√≠as, el Congo enfrenta una crisis humanitaria derivada de la miner√≠a del cobalto, marcada por el trabajo infantil y la degradaci√≥n de los ecosistemas.</p>
                    <p>A su vez, Indonesia vive una deforestaci√≥n acelerada por la expansi√≥n de la miner√≠a del n√≠quel, indispensable para la producci√≥n de veh√≠culos el√©ctricos.</p>
                    <p class="font-semibold border-t pt-4">Ante este panorama, se hace urgente un sistema que brinde informaci√≥n clara y verificable sobre el impacto real de las tecnolog√≠as que se presentan como ambientalmente responsables, permitiendo un consumo verdaderamente informado. Este principio fundamenta el proyecto de tesis doctoral en Estudios de Dise√±o de la Universidad Pontificia Bolivariana de Medell√≠n, desarrollado por el profesor del Departamento de Dise√±o de la Universidad del Valle, Pablo Andr√©s Jaramillo Romero, titulado "An√°lisis cr√≠tico del discurso visual publicitario de veh√≠culos el√©ctricos en Colombia: narrativas de sostenibilidad construidas mediante estrategias de greenwashing". En esta investigaci√≥n se evidencian las estrategias discursivas y visuales utilizadas por la publicidad para construir una imagen de sostenibilidad, as√≠ como los impactos sociales y ecol√≥gicos que acompa√±an la producci√≥n y consumo de estas tecnolog√≠as.</p>
                </div>
            </div>

            <div class="text-center mt-8">
                <button onclick="switchToAnalysis()" class="btn-primary text-lg px-8 py-4">
                    <svg class="inline w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                    </svg>
                    Iniciar an√°lisis cr√≠tico
                </button>
            </div>
        </div>

        <!-- PANTALLA 2: AN√ÅLISIS -->
        <div id="analysis-view" class="hidden">
            <header class="text-center mb-8">
                <h1 class="text-4xl font-bold text-gray-900 mb-2">An√°lisis GreenCheck</h1>
                <p class="text-sm text-gray-500">Herramienta de an√°lisis cr√≠tico del discurso visual publicitario</p>
            </header>

            <div class="card bg-yellow-50 border-2 border-yellow-300">
                <h2 class="text-xl font-bold text-yellow-900 mb-3">¬øQu√© es el greenwashing?</h2>
                <p class="text-gray-800 leading-relaxed">
                    Greenwashing o lavado verde es una estrategia de marketing contempor√°nea en la que la publicidad utiliza recursos visuales asociados a la naturaleza ‚Äîcomo entornos ecol√≥gicos, hojas, gotas de agua, ondas de mar o tipograf√≠as en tonos fr√≠os como el verde y el azul‚Äî para construir una apariencia de sostenibilidad. Estas piezas suelen transmitir sensaciones de frescura, pureza y aire limpio, con el prop√≥sito de presentar productos como ambientalmente responsables. Sin embargo, detr√°s de esta est√©tica "verde" se ocultan los verdaderos impactos ambientales derivados de la extracci√≥n de materias primas necesarias para la fabricaci√≥n de tecnolog√≠as modernas de energ√≠a. En esencia, el greenwashing consiste en hacer parecer ecol√≥gico un producto que no lo es, omitiendo deliberadamente el origen y las consecuencias de los recursos utilizados en su producci√≥n.
                </p>
            </div>

            <h2 class="text-2xl font-bold text-gray-900 mb-4 mt-8">Iniciar el chequeo de publicidad</h2>

            <!-- SECCI√ìN 1: CARGAR IMAGEN -->
            <div class="card">
                <h3 class="text-lg font-semibold text-gray-900 mb-3">1. Cargar imagen de la publicidad</h3>
                <input type="file" id="image-upload" accept="image/*" class="w-full p-3 border-2 border-gray-300 rounded-lg cursor-pointer">
                <div id="image-preview-container" class="mt-4 hidden">
                    <img id="image-preview" class="max-h-64 mx-auto rounded-lg border-2 border-gray-200" alt="Vista previa">
                </div>
            </div>

            <!-- SECCI√ìN 2: CONFIGURAR Y ANALIZAR -->
            <div class="card">
                <h3 class="text-lg font-semibold text-gray-900 mb-3">2. Configurar y analizar</h3>
                <label class="block text-sm font-medium text-gray-700 mb-2">Criterios adicionales de an√°lisis (opcional):</label>
                <textarea id="additional-criteria" rows="3" class="w-full p-3 border-2 border-gray-300 rounded-lg focus:border-green-600 focus:outline-none" 
                          placeholder="Ej: Revisar huella de carbono, analizar materiales utilizados, verificar certificaciones..."></textarea>
                
                <div class="flex gap-4 mt-4">
                    <button id="analyze-button" onclick="startAnalysis()" disabled class="btn-primary flex-1 disabled:opacity-50 disabled:cursor-not-allowed">
                        <svg class="inline w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"></path>
                        </svg>
                        Iniciar an√°lisis
                    </button>
                    <button onclick="resetAnalysis()" class="btn-secondary flex-1">
                        <svg class="inline w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                        </svg>
                        Borrar y cargar nuevo an√°lisis
                    </button>
                </div>
                
                <!-- BOT√ìN DE DIAGN√ìSTICO DE API -->
                <div class="mt-4">
                    <button onclick="diagnosticarAPI()" class="w-full py-2 px-4 bg-yellow-500 hover:bg-yellow-600 text-white rounded-lg text-sm font-medium">
                        üîç Diagnosticar conexi√≥n con API (si hay errores)
                    </button>
                </div>

                <div id="loading" class="hidden mt-6 text-center">
                    <div class="spinner mx-auto"></div>
                    <p id="loading-msg" class="text-gray-600 mt-3">Analizando imagen... Este proceso puede tardar unos segundos.</p>
                    <p class="text-xs text-gray-400 mt-1">El sistema reintentar√° autom√°ticamente si hay demoras.</p>
                </div>

                <!-- Cuadro de error amigable -->
                <div id="error-box" class="hidden mt-4 p-4 bg-red-50 border-2 border-red-300 rounded-lg">
                    <div class="flex items-start gap-3">
                        <svg class="w-6 h-6 text-red-500 mt-0.5 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"/>
                        </svg>
                        <div>
                            <p class="font-bold text-red-800 mb-1">No se pudo completar el an√°lisis</p>
                            <p id="error-msg" class="text-red-700 text-sm mb-3"></p>
                            <button onclick="retryAnalysis()" class="btn-primary bg-red-600 hover:bg-red-700 text-sm py-2 px-4">
                                üîÑ Reintentar an√°lisis
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- SECCI√ìN 3: RESULTADOS DEL AN√ÅLISIS -->
            <div id="results-section" class="hidden">
                <h2 class="text-2xl font-bold text-gray-900 mb-4 mt-8">3. Resultado del an√°lisis</h2>

                <!-- √çNDICE ZIOLO-BAK -->
                <div class="card bg-gradient-to-r from-red-50 to-orange-50 border-2 border-red-300">
                    <h3 class="text-xl font-bold text-gray-900 mb-4 pb-3 border-b-2 border-red-400">√çndice de Greenwashing Ziolo-Bak (0-100)</h3>
                    <div id="ziolo-bak-content"></div>
                </div>

                <!-- GR√ÅFICO DE TELARA√ëA -->
                <div class="card">
                    <h3 class="text-xl font-bold text-gray-900 mb-4">An√°lisis de Discursos Presentes (Hickman)</h3>
                    <div class="w-full max-w-2xl mx-auto h-96">
                        <canvas id="radar-chart"></canvas>
                    </div>
                </div>

                <!-- DESGLOSE DE GREENWASHING -->
                <div class="card">
                    <h3 class="text-xl font-bold text-gray-900 mb-4">Desglose de puntuaci√≥n de greenwashing</h3>
                    <div id="breakdown-content" class="overflow-x-auto"></div>
                </div>

                <!-- INCOMPLETITUDES -->
                <div class="card">
                    <h3 class="text-xl font-bold text-gray-900 mb-4">Incompletitudes y contexto del discurso</h3>
                    <p class="text-sm text-gray-600 mb-4">Simulaci√≥n de conceptos detectados en textos y comentarios relacionados con la publicidad</p>
                    <div id="incompletitudes-content" class="overflow-x-auto"></div>
                </div>

                <!-- GR√ÅFICO DE TORTA -->
                <div class="card">
                    <h3 class="text-xl font-bold text-gray-900 mb-4">Distribuci√≥n de afirmaciones analizadas</h3>
                    <div class="w-full max-w-md mx-auto h-80">
                        <canvas id="pie-chart"></canvas>
                    </div>
                </div>

                <!-- AN√ÅLISIS CUALITATIVO -->
                <div class="card">
                    <h3 class="text-xl font-bold text-gray-900 mb-4">An√°lisis de lavado verde (Greenwashing)</h3>
                    <div id="qualitative-analysis" class="prose max-w-none"></div>
                </div>

                <!-- NUEVO: AN√ÅLISIS NORMATIVO Y CERTIFICACIONES -->
                <div class="card">
                    <h3 class="text-xl font-bold text-gray-900 mb-4">An√°lisis de cumplimiento normativo y certificaciones</h3>
                    <div id="normative-analysis" class="space-y-4"></div>
                </div>

                <!-- NUEVO: AN√ÅLISIS DE PALETA CROM√ÅTICA -->
                <div class="card">
                    <h3 class="text-xl font-bold text-gray-900 mb-4">An√°lisis de paleta crom√°tica</h3>
                    <p class="text-sm text-gray-500 mb-4">Extracci√≥n colorim√©trica mediante cuantizaci√≥n de color (Color Thief) ‚Äî 5 colores dominantes detectados en la imagen</p>
                    <div id="chromatic-analysis"></div>
                </div>
            </div>

            <footer class="mt-12 pt-6 border-t text-center text-sm text-gray-400">
                Dise√±ado por Grupo de Investigaci√≥n Socua Departamento de Dise√±o Universidad del Valle, Grupo de investigaci√≥n en Dise√±o de la Universidad Pontificia Bolivariana de Medell√≠n
            </footer>
        </div>
    </div>

    <script>
        // Variables globales
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        // CONFIGURACI√ìN DE API - IMPORTANTE
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        // Esta API key es de prueba y puede estar agotada.
        // Para uso prolongado, obt√©n tu propia key gratis en:
        // https://makersuite.google.com/app/apikey
        // Instrucciones:
        // 1. Ve a https://makersuite.google.com/app/apikey
        // 2. Haz clic en "Create API key"
        // 3. Copia la key generada
        // 4. Reemplaza el valor de API_KEY abajo
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        
        const API_KEY = "AIzaSyACfVRW8cMNgo8_VqEwXtB7P37q6owzY-I";
        const API_URL = "https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash:generateContent";
        
        let base64Image = null;
        let imageMimeType = 'image/jpeg'; // Default
        let analysisData = {};
        let radarChart = null;
        let pieChart = null;

        // Cambio de pantalla
        function switchToAnalysis() {
            console.log('Cambiando a an√°lisis...');
            document.getElementById('landing-view').classList.add('hidden');
            document.getElementById('analysis-view').classList.remove('hidden');
        }

        // Reset
        function resetAnalysis() {
            document.getElementById('image-upload').value = '';
            document.getElementById('image-preview-container').classList.add('hidden');
            document.getElementById('additional-criteria').value = '';
            document.getElementById('results-section').classList.add('hidden');
            document.getElementById('analyze-button').disabled = true;
            base64Image = null;
            analysisData = {};
            if (radarChart) radarChart.destroy();
            if (pieChart) pieChart.destroy();
        }

        // Manejo de carga de imagen
        document.addEventListener('DOMContentLoaded', function() {
            document.getElementById('image-upload').addEventListener('change', function(e) {
                const file = e.target.files[0];
                if (file) {
                    // Validar que sea una imagen
                    if (!file.type.startsWith('image/')) {
                        alert('Por favor seleccione un archivo de imagen');
                        return;
                    }
                    
                    const reader = new FileReader();
                    reader.onload = function(event) {
                        const img = new Image();
                        img.onload = function() {
                            // Convertir cualquier imagen a JPEG usando canvas
                            const canvas = document.createElement('canvas');
                            
                            // Redimensionar si es muy grande (m√°ximo 2048px)
                            let width = img.width;
                            let height = img.height;
                            const maxSize = 2048;
                            
                            if (width > maxSize || height > maxSize) {
                                if (width > height) {
                                    height = (height / width) * maxSize;
                                    width = maxSize;
                                } else {
                                    width = (width / height) * maxSize;
                                    height = maxSize;
                                }
                            }
                            
                            canvas.width = width;
                            canvas.height = height;
                            
                            const ctx = canvas.getContext('2d');
                            ctx.drawImage(img, 0, 0, width, height);
                            
                            // Convertir a JPEG con calidad 85%
                            const jpegDataUrl = canvas.toDataURL('image/jpeg', 0.85);
                            
                            // Mostrar preview
                            document.getElementById('image-preview').src = jpegDataUrl;
                            document.getElementById('image-preview-container').classList.remove('hidden');
                            
                            // Guardar para enviar
                            base64Image = jpegDataUrl.split(',')[1];
                            imageMimeType = 'image/jpeg';
                            
                            document.getElementById('analyze-button').disabled = false;
                            
                            console.log('Imagen procesada:', {
                                dimensiones: `${width}x${height}`,
                                tama√±o: (base64Image.length / 1024).toFixed(0) + ' KB',
                                formato: 'JPEG'
                            });
                        };
                        img.src = event.target.result;
                    };
                    reader.readAsDataURL(file);
                }
            });
        });

        // An√°lisis
        // Reintentar an√°lisis manualmente
        function retryAnalysis() {
            document.getElementById('error-box').classList.add('hidden');
            startAnalysis();
        }

        // FUNCI√ìN DE DIAGN√ìSTICO EN TIEMPO REAL
        async function diagnosticarAPI() {
            const msgDiv = document.getElementById('loading-msg');
            const loadingDiv = document.getElementById('loading');
            
            loadingDiv.classList.remove('hidden');
            msgDiv.innerHTML = 'üîç Diagnosticando API...<br><br>';
            
            const modelos = [
                "gemini-1.5-flash",
                "gemini-1.5-pro", 
                "gemini-pro",
                "gemini-pro-vision"
            ];
            
            let funcionaAlguno = false;
            
            for (const modelo of modelos) {
                const url = `https://generativelanguage.googleapis.com/v1beta/models/${modelo}:generateContent`;
                msgDiv.innerHTML += `Probando ${modelo}... `;
                
                try {
                    const response = await fetch(`${url}?key=${API_KEY}`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            contents: [{ parts: [{ text: "test" }] }]
                        })
                    });
                    
                    if (response.ok) {
                        msgDiv.innerHTML += `<span style="color: green; font-weight: bold;">‚úÖ FUNCIONA</span><br>`;
                        funcionaAlguno = true;
                        
                        if (modelo !== "gemini-1.5-flash") {
                            msgDiv.innerHTML += `<br><strong style="color: red;">‚ö†Ô∏è PROBLEMA ENCONTRADO:</strong><br>`;
                            msgDiv.innerHTML += `El modelo correcto es: <strong>${modelo}</strong><br>`;
                            msgDiv.innerHTML += `Pero el c√≥digo usa: gemini-1.5-flash<br><br>`;
                            msgDiv.innerHTML += `<strong>SOLUCI√ìN:</strong> Edita el archivo HTML y cambia la l√≠nea:<br>`;
                            msgDiv.innerHTML += `<code style="background: #f0f0f0; padding: 5px;">const API_URL = "...${modelo}:generateContent";</code><br><br>`;
                        }
                        break;
                    } else {
                        const data = await response.json();
                        msgDiv.innerHTML += `<span style="color: red;">‚ùå Error ${response.status}</span><br>`;
                        if (data.error) {
                            msgDiv.innerHTML += `<small>${data.error.message || JSON.stringify(data.error)}</small><br>`;
                        }
                    }
                } catch (error) {
                    msgDiv.innerHTML += `<span style="color: red;">‚ùå ${error.message}</span><br>`;
                }
                
                await new Promise(r => setTimeout(r, 500));
            }
            
            if (!funcionaAlguno) {
                msgDiv.innerHTML += `<br><strong style="color: red;">‚ùå NING√öN MODELO FUNCIONA</strong><br><br>`;
                msgDiv.innerHTML += `Posibles causas:<br>`;
                msgDiv.innerHTML += `1. La API key tiene restricciones<br>`;
                msgDiv.innerHTML += `2. La API no est√° habilitada en el proyecto<br>`;
                msgDiv.innerHTML += `3. Problema de facturaci√≥n<br><br>`;
                msgDiv.innerHTML += `Ve a: <a href="https://console.cloud.google.com/apis/credentials" target="_blank">Google Cloud Console</a><br>`;
            } else if (!msgDiv.innerHTML.includes('PROBLEMA ENCONTRADO')) {
                msgDiv.innerHTML += `<br><strong style="color: green;">‚úÖ TODO CORRECTO</strong><br>`;
                msgDiv.innerHTML += `La API funciona. Si GreenCheck falla, recarga la p√°gina (Ctrl+Shift+R).<br>`;
            }
        }

        async function startAnalysis() {
            if (!base64Image) {
                alert('Por favor carga una imagen primero');
                return;
            }

            document.getElementById('loading').classList.remove('hidden');
            document.getElementById('analyze-button').disabled = true;
            document.getElementById('results-section').classList.add('hidden');
            document.getElementById('error-box').classList.add('hidden');

            const additionalCriteria = document.getElementById('additional-criteria').value || 'Ninguno';

            const systemInstruction = `Eres GreenCheck AI, un sistema experto en an√°lisis cr√≠tico del discurso visual publicitario.

GENERA UN √öNICO OBJETO JSON con esta estructura EXACTA (sin texto adicional, solo JSON puro):

{
  "ziolo_bak": {
    "ejecucional_empresa": {
      "presente": true/false,
      "componentes_detectados": "Descripci√≥n de s√≠mbolos, colores, sonidos y narrativas verdes relacionadas con la marca"
    },
    "afirmacion_empresa": {
      "presente": true/false,
      "componentes_detectados": "Descripci√≥n de declaraciones institucionales detectadas (ej: 'comprometidos con el cambio clim√°tico', 'cero emisiones', etc.)"
    },
    "ejecucional_producto": {
      "presente": true/false,
      "componentes_detectados": "Descripci√≥n de recursos visuales sostenibles (hojas, gotas, elementos ambientales por color/forma)"
    },
    "afirmacion_producto": {
      "presente": true/false,
      "componentes_detectados": "Descripci√≥n de frases ecol√≥gicas (ej: 'emisiones 0', '100% natural', 'ecol√≥gico')"
    }
  },
  "discursos_hickman": {
    "estatus_social": 75,
    "libertad_movimiento": 85,
    "solucion_ambiental": 60,
    "mensaje_ecologico": 70,
    "simplicidad_eficiencia": 50,
    "normativas": 30
  },
  "desglose_greenwashing": [
    {"criterio": "S√≠mbolos ecol√≥gicos gen√©ricos (hojas, tierra, etc.)", "peso": 30, "detectado": true},
    {"criterio": "Uso de colores fr√≠os/naturales no relacionados con el producto (azul, verde)", "peso": 20, "detectado": true},
    {"criterio": "Entorno natural (bosque, playa, agua) como fondo del producto", "peso": 20, "detectado": false},
    {"criterio": "Presencia de animales", "peso": 10, "detectado": false},
    {"criterio": "Muestra el producto con familia (conexi√≥n emocional)", "peso": 5, "detectado": true},
    {"criterio": "Elementos caracter√≠sticos del pa√≠s (bandera, trajes t√≠picos)", "peso": 5, "detectado": false},
    {"criterio": "S√≠mbolo claro como una hoja o folio de un √°rbol en color azul o verde", "peso": 10, "detectado": true}
  ],
  "incompletitudes": {
    "valores_afirmativos": {
      "sostenibilidad": true,
      "libertad": true,
      "tecnologia": true,
      "metas_aspiracionales": false,
      "impactos_positivos": true
    },
    "impactos_criticos": {
      "extraccion_minerales": false,
      "paises_origen": false
    },
    "contexto_social": {
      "geografia_pais": false,
      "infraestructura_carga": false,
      "infraestructura_vial": false,
      "climatologia": false
    }
  },
  "analisis_normativo_certificaciones": {
    "fecha_publicacion_detectada": "2023-05-15 o 'No detectada'",
    "marco_legal_aplicable": {
      "ley_1931_2018": {
        "aplicable": true,
        "descripcion": "Ley de cambio clim√°tico - Aplica a veh√≠culos el√©ctricos posteriores a 2018"
      },
      "ley_1964_2019": {
        "aplicable": true,
        "beneficios_mencionados": {
          "rebaja_impuesto_vehicular": false,
          "descuento_soat": false,
          "exencion_pico_placa": true
        }
      },
      "normativas_locales": {
        "mencionadas": false,
        "descripcion": "Rebaja impuestos y parqueo preferencial"
      }
    },
    "certificaciones_internacionales": {
      "wltp_comision_europea": {
        "presente": false,
        "descripcion": "Sello o menci√≥n de WLTP (consumo energ√≠a, emisiones, autonom√≠a)"
      },
      "ghg_protocol": {
        "presente": false,
        "descripcion": "Greenhouse Gas Protocol - Emisiones directas e indirectas"
      },
      "iso_14044": {
        "presente": false,
        "descripcion": "ISO 14044 - An√°lisis ciclo de vida (bater√≠as, tierras raras, huella h√≠drica)"
      },
      "epa": {
        "presente": false,
        "descripcion": "EPA - Calidad ambiental y m√©tricas de eficiencia"
      }
    },
    "cherry_picking_detectado": {
      "presente": false,
      "evidencias": "Descripci√≥n de datos selectivos o escenarios que favorecen sostenibilidad sin contexto completo",
      "ejemplos": ["Solo muestra autonom√≠a, omite tiempo de carga", "Solo menciona cero emisiones, omite producci√≥n"]
    },
    "analisis_cumplimiento": "Evaluaci√≥n general del cumplimiento normativo y transparencia en certificaciones"
  },
  "analisis_cualitativo": {
    "identificacion_producto": "BYD Atto 3 - Veh√≠culo el√©ctrico",
    "fuente": "Facebook / Instagram",
    "criterios_adicionales_solicitados": "Revisar huella de carbono, analizar materiales utilizados",
    "hallazgos_criterios_adicionales": "Respecto a los criterios adicionales solicitados: [descripci√≥n de hallazgos o 'No se encontr√≥ informaci√≥n espec√≠fica sobre estos criterios en la publicidad']",
    "afirmaciones_clave": ["100% Ecol√≥gico", "Cero emisiones", "Movilidad sostenible"],
    "evaluacion_greencheck": "La publicidad presenta el producto como soluci√≥n ambiental absoluta, utilizando narrativas de libertad y status social. Se detecta uso estrat√©gico de colores verdes y azules.",
    "greenwashing_detectado": "Afirmaci√≥n '100% Ecol√≥gico' es exageraci√≥n que omite impactos de producci√≥n de bater√≠as (litio, cobalto). Uso de colores fr√≠os para crear halo de naturaleza sobre producto industrial.",
    "puntos_verdes": "El veh√≠culo el√©ctrico es genuina alternativa a combusti√≥n interna. Reduce contaminaci√≥n local en uso urbano.",
    "clasificacion": "Moderado Riesgo de Greenwashing",
    "recomendacion": "Reemplazar '100% Ecol√≥gico' por 'Cero Emisiones en Uso'. Incluir informaci√≥n sobre origen de bater√≠as y reciclaje."
  }
}`;

            const payload = {
                contents: [{
                    role: "user",
                    parts: [
                        { text: `Analiza esta publicidad de tecnolog√≠a verde siguiendo la estructura JSON indicada.

${additionalCriteria !== 'Ninguno' ? `CRITERIOS ADICIONALES SOLICITADOS POR EL USUARIO: "${additionalCriteria}"
Por favor, en el campo "criterios_adicionales_solicitados" copia exactamente estos criterios, y en "hallazgos_criterios_adicionales" describe brevemente si encuentras informaci√≥n relacionada con estos criterios en la publicidad, o indica claramente si no se encontr√≥ informaci√≥n sobre ellos.` : ''}

RESPONDE SOLO CON JSON, SIN TEXTO ADICIONAL.` },
                        { inlineData: { mimeType: imageMimeType, data: base64Image } }
                    ]
                }],
                systemInstruction: { parts: [{ text: systemInstruction }] }
            };

            // Funci√≥n de llamada a API con reintentos autom√°ticos
            async function callGeminiAPI(payload, intentoActual = 1, maxIntentos = 3) {
                const loadingMsg = document.getElementById('loading-msg');
                if (loadingMsg) {
                    loadingMsg.textContent = intentoActual > 1 
                        ? `Reintentando... (intento ${intentoActual} de ${maxIntentos})` 
                        : 'Analizando imagen... Este proceso puede tardar unos segundos.';
                }

                const response = await fetch(`${API_URL}?key=${API_KEY}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                // Si es 503 o 429 y a√∫n hay intentos, esperar y reintentar
                if ((response.status === 503 || response.status === 429) && intentoActual < maxIntentos) {
                    const espera = intentoActual * 4000; // 4s, 8s
                    if (loadingMsg) loadingMsg.textContent = `Servidor ocupado. Reintentando en ${espera/1000} segundos... (${intentoActual}/${maxIntentos})`;
                    await new Promise(resolve => setTimeout(resolve, espera));
                    return callGeminiAPI(payload, intentoActual + 1, maxIntentos);
                }

                if (!response.ok) {
                    const errorTexts = {
                        404: 'El modelo de IA no est√° disponible o la API key ha expirado. Posibles soluciones: (1) Espere unos minutos y reintente, (2) Obtenga una API key propia en https://makersuite.google.com/app/apikey y reempl√°cela en el c√≥digo.',
                        503: 'El servidor de IA est√° temporalmente sobrecargado. Por favor intente nuevamente en unos minutos.',
                        429: 'Se super√≥ el l√≠mite de solicitudes. Espere un momento antes de volver a intentar.',
                        400: 'Error en el formato de la imagen. Intente con otra imagen.',
                        401: 'Error de autenticaci√≥n con la API key. Necesita configurar una API key v√°lida en el c√≥digo.',
                        500: 'Error interno del servidor de IA. Intente nuevamente.'
                    };
                    const msg = errorTexts[response.status] || `Error del servidor (c√≥digo ${response.status}). Intente nuevamente.`;
                    throw new Error(msg);
                }

                return response;
            }

            try {
                const response = await callGeminiAPI(payload);
                const result = await response.json();
                
                console.log('Respuesta completa de Gemini:', result);
                
                let text = result?.candidates?.[0]?.content?.parts?.[0]?.text;

                if (text) {
                    text = text.replace(/```json/g, '').replace(/```/g, '').trim();
                    analysisData = JSON.parse(text);
                    displayResults();
                } else if (result.error) {
                    // Mostrar el error espec√≠fico de Gemini
                    throw new Error(`Error de Gemini: ${result.error.message || JSON.stringify(result.error)}`);
                } else {
                    throw new Error('La API no devolvi√≥ contenido. Intente nuevamente.');
                }
            } catch (error) {
                console.error('Error completo:', error);
                console.error('Tipo MIME usado:', imageMimeType);
                console.error('Tama√±o de base64:', base64Image ? base64Image.length : 0);
                
                // Mostrar error amigable en pantalla
                document.getElementById('loading').classList.add('hidden');
                document.getElementById('error-box').classList.remove('hidden');
                document.getElementById('error-msg').innerHTML = error.message + 
                    '<br><br><strong>Debug info:</strong><br>' +
                    'Tipo MIME: ' + imageMimeType + '<br>' +
                    'Tama√±o datos: ' + (base64Image ? (base64Image.length / 1024).toFixed(0) + ' KB' : 'N/A');
            } finally {
                document.getElementById('loading').classList.add('hidden');
                document.getElementById('analyze-button').disabled = false;
            }
        }

        function displayResults() {
            document.getElementById('results-section').classList.remove('hidden');
            document.getElementById('results-section').scrollIntoView({ behavior: 'smooth' });

            displayZioloBak();
            displayRadarChart();
            displayBreakdown();
            displayIncompletitudes();
            displayPieChart();
            displayQualitativeAnalysis();
            displayNormativeAnalysis(); // NUEVO
            displayChromaticAnalysis(); // NUEVO: Paleta crom√°tica
        }

        function displayZioloBak() {
            const zb = analysisData.ziolo_bak;
            
            const categories = [
                { 
                    label: 'Ejecucional nivel empresa', 
                    desc: 'Uso de s√≠mbolos, colores, sonidos y narrativas verdes asociados a la marca',
                    presente: zb.ejecucional_empresa.presente,
                    componentes: zb.ejecucional_empresa.componentes_detectados
                },
                { 
                    label: 'Afirmaci√≥n nivel empresa', 
                    desc: 'Declaraciones institucionales (ej: "comprometidos con el cambio clim√°tico", "cero emisiones")',
                    presente: zb.afirmacion_empresa.presente,
                    componentes: zb.afirmacion_empresa.componentes_detectados
                },
                { 
                    label: 'Ejecucional nivel producto', 
                    desc: 'Recursos visuales que aparentan sostenibilidad (hojas, gotas de agua, elementos ambientales)',
                    presente: zb.ejecucional_producto.presente,
                    componentes: zb.ejecucional_producto.componentes_detectados
                },
                { 
                    label: 'Afirmaci√≥n nivel producto', 
                    desc: 'Frases que acompa√±an la publicidad (ej: "emisiones 0", "100% natural", "ecol√≥gico")',
                    presente: zb.afirmacion_producto.presente,
                    componentes: zb.afirmacion_producto.componentes_detectados
                }
            ];

            let html = `
                <table class="w-full">
                    <thead>
                        <tr class="bg-gray-200">
                            <th class="text-left p-3">Categor√≠a Ziolo-Bak</th>
                            <th class="text-left p-3">Descripci√≥n</th>
                            <th class="text-center p-3 w-24">Presente</th>
                        </tr>
                    </thead>
                    <tbody>
            `;

            categories.forEach(cat => {
                const presente = cat.presente ? 'S√ç' : 'NO';
                const presenteColor = cat.presente ? 'text-red-600 font-bold' : 'text-green-600 font-bold';
                const rowBg = cat.presente ? 'bg-red-50' : 'bg-green-50';
                
                html += `
                    <tr class="${rowBg}">
                        <td class="p-3 font-semibold">${cat.label}</td>
                        <td class="p-3 text-sm">
                            <div class="text-gray-600 mb-1">${cat.desc}</div>
                            <div class="text-gray-800 italic">${cat.componentes}</div>
                        </td>
                        <td class="p-3 text-center text-2xl ${presenteColor}">${presente}</td>
                    </tr>
                `;
            });

            html += `
                    </tbody>
                </table>
            `;

            document.getElementById('ziolo-bak-content').innerHTML = html;
        }

        function displayRadarChart() {
            const ctx = document.getElementById('radar-chart').getContext('2d');
            if (radarChart) radarChart.destroy();

            const disc = analysisData.discursos_hickman;
            radarChart = new Chart(ctx, {
                type: 'radar',
                data: {
                    labels: ['Estatus social', 'Libertad de movimiento', 'Soluci√≥n ambiental', 'Mensaje ecol√≥gico', 'Simplicidad y eficiencia', 'Normativas gubernamentales'],
                    datasets: [{
                        label: 'Intensidad del discurso',
                        data: [disc.estatus_social, disc.libertad_movimiento, disc.solucion_ambiental, disc.mensaje_ecologico, disc.simplicidad_eficiencia, disc.normativas],
                        backgroundColor: 'rgba(5, 150, 105, 0.2)',
                        borderColor: 'rgb(5, 150, 105)',
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        r: {
                            suggestedMin: 10,
                            suggestedMax: 100,
                            ticks: { stepSize: 10 }
                        }
                    }
                }
            });
        }

        function displayBreakdown() {
            const breakdown = analysisData.desglose_greenwashing;
            let totalDetected = 0;

            let html = '<table><thead><tr><th>Criterio (Discurso Impl√≠cito)</th><th class="text-center">Peso M√°ximo</th><th class="text-center">Detectado</th><th class="text-center">Puntuaci√≥n Sumada</th></tr></thead><tbody>';

            breakdown.forEach(item => {
                const score = item.detectado ? item.peso : 0;
                totalDetected += score;
                const checkIcon = item.detectado ? '‚úì' : '‚úó';
                const rowClass = item.detectado ? 'bg-red-50' : 'bg-green-50';

                html += `<tr class="${rowClass}"><td>${item.criterio}</td><td class="text-center font-semibold">${item.peso}%</td><td class="text-center text-2xl">${checkIcon}</td><td class="text-center font-bold">${score}%</td></tr>`;
            });

            html += `</tbody><tfoot class="bg-red-100"><tr><td colspan="3" class="text-right font-bold text-lg">TOTAL GREENWASHING DETECTADO:</td><td class="text-center font-bold text-xl text-red-600">${totalDetected}%</td></tr></tfoot></table>`;

            document.getElementById('breakdown-content').innerHTML = html;
        }

        function displayIncompletitudes() {
            const inc = analysisData.incompletitudes;
            
            let html = '<table><thead><tr><th>Concepto detallado</th><th class="text-center">Mencionado</th><th class="text-center">Inferencia</th></tr></thead><tbody>';

            const sections = [
                { title: 'Valores afirmativos y metas', data: inc.valores_afirmativos, labels: ['Sostenibilidad', 'Libertad', 'Tecnolog√≠a', 'Metas aspiracionales', 'Impactos positivos'] },
                { title: 'Impactos cr√≠ticos (Greenwashing faltante)', data: inc.impactos_criticos, labels: ['Extracci√≥n de minerales', 'Pa√≠ses de origen'] },
                { title: 'Contexto social/operacional', data: inc.contexto_social, labels: ['Geograf√≠a del pa√≠s', 'Infraestructura de carga', 'Infraestructura vial', 'Climatolog√≠a'] }
            ];

            sections.forEach(section => {
                html += `<tr class="bg-blue-100"><td colspan="3" class="font-bold">${section.title}</td></tr>`;
                const keys = Object.keys(section.data);
                keys.forEach((key, i) => {
                    const mentioned = section.data[key];
                    const icon = mentioned ? '‚úì' : '‚úó';
                    const color = mentioned ? 'text-green-600' : 'text-red-600';
                    html += `<tr><td>${section.labels[i]}</td><td class="text-center ${color} text-xl">${icon}</td><td class="text-center ${color} text-xl">${icon}</td></tr>`;
                });
            });

            html += '</tbody></table>';
            document.getElementById('incompletitudes-content').innerHTML = html;
        }

        function displayPieChart() {
            const breakdown = analysisData.desglose_greenwashing;
            const greenwashing = breakdown.filter(item => item.detectado).reduce((sum, item) => sum + item.peso, 0);
            const legitimate = 100 - greenwashing;

            const ctx = document.getElementById('pie-chart').getContext('2d');
            if (pieChart) pieChart.destroy();

            pieChart = new Chart(ctx, {
                type: 'pie',
                data: {
                    labels: [`Greenwashing detectado (${greenwashing}%)`, `Afirmaciones leg√≠timas/neutrales (${legitimate}%)`],
                    datasets: [{
                        data: [greenwashing, legitimate],
                        backgroundColor: ['#dc2626', '#059669']
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false
                }
            });
        }

        function displayQualitativeAnalysis() {
            const qa = analysisData.analisis_cualitativo;
            
            let html = `
                <div class="space-y-4">
                    <div><h4 class="font-bold text-gray-900">Identificaci√≥n del producto</h4><p>${qa.identificacion_producto}</p></div>
                    <div><h4 class="font-bold text-gray-900">Fuente</h4><p>${qa.fuente}</p></div>`;
            
            // Mostrar criterios adicionales si fueron solicitados
            if (qa.criterios_adicionales_solicitados && qa.criterios_adicionales_solicitados !== 'Ninguno') {
                html += `
                    <div class="bg-blue-50 p-4 rounded-lg border-2 border-blue-300">
                        <h4 class="font-bold text-blue-900">Criterios adicionales solicitados</h4>
                        <p class="text-sm text-gray-700 mb-2 italic">${qa.criterios_adicionales_solicitados}</p>
                        <h5 class="font-semibold text-blue-800 mt-3">Hallazgos:</h5>
                        <p class="text-gray-800">${qa.hallazgos_criterios_adicionales}</p>
                    </div>`;
            }
            
            html += `
                    <div><h4 class="font-bold text-gray-900">Afirmaciones clave</h4><ul class="list-disc pl-5">${qa.afirmaciones_clave.map(a => `<li>${a}</li>`).join('')}</ul></div>
                    <div><h4 class="font-bold text-gray-900">Evaluaci√≥n GreenCheck</h4><p>${qa.evaluacion_greencheck}</p></div>
                    <div class="bg-red-50 p-4 rounded-lg"><h4 class="font-bold text-red-900">Greenwashing detectado</h4><p>${qa.greenwashing_detectado}</p></div>
                    <div class="bg-green-50 p-4 rounded-lg"><h4 class="font-bold text-green-900">Puntos verdes</h4><p>${qa.puntos_verdes}</p></div>
                    <div class="bg-yellow-50 p-4 rounded-lg border-2 border-yellow-400"><h4 class="font-bold text-yellow-900">Clasificaci√≥n GreenCheck</h4><p class="text-xl font-bold">${qa.clasificacion}</p></div>
                    <div><h4 class="font-bold text-gray-900">Recomendaci√≥n</h4><p>${qa.recomendacion}</p></div>
                </div>
            `;

            document.getElementById('qualitative-analysis').innerHTML = html;
        }

        // NUEVA FUNCI√ìN: Mostrar an√°lisis normativo y certificaciones
        function displayNormativeAnalysis() {
            const na = analysisData.analisis_normativo_certificaciones;
            
            if (!na) {
                document.getElementById('normative-analysis').innerHTML = '<p class="text-gray-500">No hay datos de an√°lisis normativo disponibles.</p>';
                return;
            }
            
            let html = `
                <div class="bg-blue-50 p-4 rounded-lg border-2 border-blue-300 mb-4">
                    <h4 class="font-bold text-blue-900 mb-2">Fecha de publicaci√≥n detectada</h4>
                    <p class="text-lg text-gray-800">${na.fecha_publicacion_detectada || 'No detectada'}</p>
                </div>

                <div class="mb-6">
                    <h4 class="font-bold text-gray-900 mb-3 text-lg border-b-2 border-gray-300 pb-2">Marco legal colombiano aplicable</h4>
                    
                    <div class="space-y-3">
                        <div class="border-l-4 border-green-500 pl-4 py-2 ${na.marco_legal_aplicable.ley_1931_2018.aplicable ? 'bg-green-50' : 'bg-gray-50'}">
                            <div class="flex justify-between items-center">
                                <div>
                                    <span class="font-semibold">Ley 1931 de 2018</span>
                                    <p class="text-sm text-gray-600">${na.marco_legal_aplicable.ley_1931_2018.descripcion}</p>
                                </div>
                                <span class="text-lg font-bold ${na.marco_legal_aplicable.ley_1931_2018.aplicable ? 'text-green-600' : 'text-gray-400'}">
                                    ${na.marco_legal_aplicable.ley_1931_2018.aplicable ? 'APLICABLE' : 'N/A'}
                                </span>
                            </div>
                        </div>

                        <div class="border-l-4 border-blue-500 pl-4 py-3 bg-blue-50">
                            <div class="font-semibold mb-3">Ley 1964 de 2019 - Beneficios mencionados en publicidad:</div>
                            <div class="grid grid-cols-1 md:grid-cols-3 gap-2 text-sm">
                                <div class="flex items-center justify-between p-2 bg-white rounded">
                                    <span>Rebaja impuesto (1%)</span>
                                    <span class="font-bold ${na.marco_legal_aplicable.ley_1964_2019.beneficios_mencionados.rebaja_impuesto_vehicular ? 'text-green-600' : 'text-red-600'}">
                                        ${na.marco_legal_aplicable.ley_1964_2019.beneficios_mencionados.rebaja_impuesto_vehicular ? 'S√ç' : 'NO'}
                                    </span>
                                </div>
                                <div class="flex items-center justify-between p-2 bg-white rounded">
                                    <span>Descuento SOAT (10%)</span>
                                    <span class="font-bold ${na.marco_legal_aplicable.ley_1964_2019.beneficios_mencionados.descuento_soat ? 'text-green-600' : 'text-red-600'}">
                                        ${na.marco_legal_aplicable.ley_1964_2019.beneficios_mencionados.descuento_soat ? 'S√ç' : 'NO'}
                                    </span>
                                </div>
                                <div class="flex items-center justify-between p-2 bg-white rounded">
                                    <span>Exenci√≥n pico y placa</span>
                                    <span class="font-bold ${na.marco_legal_aplicable.ley_1964_2019.beneficios_mencionados.exencion_pico_placa ? 'text-green-600' : 'text-red-600'}">
                                        ${na.marco_legal_aplicable.ley_1964_2019.beneficios_mencionados.exencion_pico_placa ? 'S√ç' : 'NO'}
                                    </span>
                                </div>
                            </div>
                        </div>

                        <div class="border-l-4 border-purple-500 pl-4 py-2 ${na.marco_legal_aplicable.normativas_locales.mencionadas ? 'bg-purple-50' : 'bg-gray-50'}">
                            <div class="flex justify-between items-center">
                                <div>
                                    <span class="font-semibold">Normativas locales</span>
                                    <p class="text-sm text-gray-600">${na.marco_legal_aplicable.normativas_locales.descripcion}</p>
                                </div>
                                <span class="text-lg font-bold ${na.marco_legal_aplicable.normativas_locales.mencionadas ? 'text-green-600' : 'text-red-600'}">
                                    ${na.marco_legal_aplicable.normativas_locales.mencionadas ? 'MENCIONADO' : 'NO MENCIONADO'}
                                </span>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="mb-6">
                    <h4 class="font-bold text-gray-900 mb-3 text-lg border-b-2 border-gray-300 pb-2">Certificaciones y est√°ndares internacionales</h4>
                    
                    <table class="w-full">
                        <thead>
                            <tr class="bg-gray-200">
                                <th class="text-left p-3">Certificaci√≥n/Est√°ndar</th>
                                <th class="text-left p-3">Descripci√≥n</th>
                                <th class="text-center p-3 w-32">Presente</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr class="${na.certificaciones_internacionales.wltp_comision_europea.presente ? 'bg-green-50' : 'bg-red-50'}">
                                <td class="p-3 font-semibold">WLTP</td>
                                <td class="p-3 text-sm">${na.certificaciones_internacionales.wltp_comision_europea.descripcion}</td>
                                <td class="p-3 text-center text-xl font-bold ${na.certificaciones_internacionales.wltp_comision_europea.presente ? 'text-green-600' : 'text-red-600'}">
                                    ${na.certificaciones_internacionales.wltp_comision_europea.presente ? 'S√ç' : 'NO'}
                                </td>
                            </tr>
                            <tr class="${na.certificaciones_internacionales.ghg_protocol.presente ? 'bg-green-50' : 'bg-red-50'}">
                                <td class="p-3 font-semibold">GHG Protocol</td>
                                <td class="p-3 text-sm">${na.certificaciones_internacionales.ghg_protocol.descripcion}</td>
                                <td class="p-3 text-center text-xl font-bold ${na.certificaciones_internacionales.ghg_protocol.presente ? 'text-green-600' : 'text-red-600'}">
                                    ${na.certificaciones_internacionales.ghg_protocol.presente ? 'S√ç' : 'NO'}
                                </td>
                            </tr>
                            <tr class="${na.certificaciones_internacionales.iso_14044.presente ? 'bg-green-50' : 'bg-red-50'}">
                                <td class="p-3 font-semibold">ISO 14044</td>
                                <td class="p-3 text-sm">${na.certificaciones_internacionales.iso_14044.descripcion}</td>
                                <td class="p-3 text-center text-xl font-bold ${na.certificaciones_internacionales.iso_14044.presente ? 'text-green-600' : 'text-red-600'}">
                                    ${na.certificaciones_internacionales.iso_14044.presente ? 'S√ç' : 'NO'}
                                </td>
                            </tr>
                            <tr class="${na.certificaciones_internacionales.epa.presente ? 'bg-green-50' : 'bg-red-50'}">
                                <td class="p-3 font-semibold">EPA</td>
                                <td class="p-3 text-sm">${na.certificaciones_internacionales.epa.descripcion}</td>
                                <td class="p-3 text-center text-xl font-bold ${na.certificaciones_internacionales.epa.presente ? 'text-green-600' : 'text-red-600'}">
                                    ${na.certificaciones_internacionales.epa.presente ? 'S√ç' : 'NO'}
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>

                <div class="border-2 ${na.cherry_picking_detectado.presente ? 'border-red-500 bg-red-50' : 'border-green-500 bg-green-50'} rounded-lg p-4">
                    <h4 class="font-bold ${na.cherry_picking_detectado.presente ? 'text-red-900' : 'text-green-900'} mb-2 flex items-center text-lg">
                        <svg class="w-6 h-6 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path>
                        </svg>
                        Cherry Picking (Selecci√≥n Selectiva de Datos)
                    </h4>
                    <div class="mb-2">
                        <span class="font-semibold">Detectado: </span>
                        <span class="text-2xl font-bold ${na.cherry_picking_detectado.presente ? 'text-red-600' : 'text-green-600'}">
                            ${na.cherry_picking_detectado.presente ? 'S√ç' : 'NO'}
                        </span>
                    </div>
                    <p class="text-sm text-gray-700 mb-2"><strong>Evidencias:</strong> ${na.cherry_picking_detectado.evidencias}</p>
                    ${na.cherry_picking_detectado.ejemplos && na.cherry_picking_detectado.ejemplos.length > 0 ? `
                        <div class="text-sm">
                            <strong>Ejemplos detectados:</strong>
                            <ul class="list-disc pl-5 mt-1">
                                ${na.cherry_picking_detectado.ejemplos.map(ej => `<li>${ej}</li>`).join('')}
                            </ul>
                        </div>
                    ` : ''}
                </div>

                <div class="mt-4 p-4 bg-gray-100 rounded-lg border-l-4 border-gray-600">
                    <h4 class="font-bold text-gray-900 mb-2">Evaluaci√≥n general de cumplimiento normativo</h4>
                    <p class="text-gray-800">${na.analisis_cumplimiento}</p>
                </div>
            `;

            document.getElementById('normative-analysis').innerHTML = html;
        }

        // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        // M√ìDULO CROM√ÅTICO ‚Äî Color Thief + clasificaci√≥n
        // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        function displayChromaticAnalysis() {
            const container = document.getElementById('chromatic-analysis');
            container.innerHTML = '<p class="text-gray-400 text-sm">Procesando paleta crom√°tica...</p>';

            const img = document.getElementById('image-preview');
            if (!img || !img.src) {
                container.innerHTML = '<p class="text-gray-400 text-sm">No hay imagen disponible.</p>';
                return;
            }

            // Usamos una imagen temporal con crossOrigin para evitar problemas CORS
            const tempImg = new Image();
            tempImg.crossOrigin = 'Anonymous';
            tempImg.src = img.src;

            tempImg.onload = function () {
                try {
                    const colorThief = new ColorThief();
                    const palette = colorThief.getPalette(tempImg, 5); // 5 colores dominantes
                    renderPalette(palette, container);
                } catch (e) {
                    // Fallback: leer pixels del canvas directamente
                    extractColorsFromCanvas(img, container);
                }
            };

            tempImg.onerror = function () {
                extractColorsFromCanvas(img, container);
            };
        }

        // Fallback: extracci√≥n directa desde canvas
        function extractColorsFromCanvas(imgEl, container) {
            try {
                const canvas = document.createElement('canvas');
                const MAX = 200;
                const scale = Math.min(MAX / imgEl.naturalWidth, MAX / imgEl.naturalHeight, 1);
                canvas.width  = Math.max(1, Math.round(imgEl.naturalWidth  * scale));
                canvas.height = Math.max(1, Math.round(imgEl.naturalHeight * scale));
                const ctx = canvas.getContext('2d');
                ctx.drawImage(imgEl, 0, 0, canvas.width, canvas.height);
                const data = ctx.getImageData(0, 0, canvas.width, canvas.height).data;

                // Cuantizaci√≥n simple: agrupar en cubos de 32
                const buckets = {};
                for (let i = 0; i < data.length; i += 4) {
                    const a = data[i + 3];
                    if (a < 128) continue; // ignorar transparentes
                    const r = Math.round(data[i]     / 32) * 32;
                    const g = Math.round(data[i + 1] / 32) * 32;
                    const b = Math.round(data[i + 2] / 32) * 32;
                    const key = `${r},${g},${b}`;
                    buckets[key] = (buckets[key] || 0) + 1;
                }

                const sorted = Object.entries(buckets)
                    .sort((a, b) => b[1] - a[1])
                    .slice(0, 5)
                    .map(([key]) => key.split(',').map(Number));

                renderPalette(sorted, container);
            } catch (e) {
                container.innerHTML = '<p class="text-red-500 text-sm">No se pudo extraer la paleta. Intente con una imagen diferente.</p>';
            }
        }

        // ‚îÄ‚îÄ‚îÄ Renderiza la paleta y clasificaci√≥n ‚îÄ‚îÄ‚îÄ
        function renderPalette(palette, container) {
            // Clasificar cada color
            const classified = palette.map(rgb => ({
                rgb,
                hex: rgbToHex(rgb[0], rgb[1], rgb[2]),
                hsl: rgbToHsl(rgb[0], rgb[1], rgb[2]),
                tipo: classifyColor(rgb[0], rgb[1], rgb[2])
            }));

            // Calcular proporci√≥n de cada tipo
            const counts = { frio: 0, calido: 0, neutro: 0 };
            classified.forEach(c => counts[c.tipo]++);
            const total = classified.length;
            const pctFrio   = Math.round((counts.frio   / total) * 100);
            const pctCalido = Math.round((counts.calido / total) * 100);
            const pctNeutro = Math.round((counts.neutro / total) * 100);

            // Determinar clasificaci√≥n general de la paleta
            let paletaClase, paletaColor, paletaDesc;
            if (pctFrio >= 60) {
                paletaClase = 'PALETA FR√çA';
                paletaColor = 'text-blue-700 bg-blue-50 border-blue-400';
                paletaDesc  = 'Predominan colores fr√≠os (azules, verdes, violetas). En publicidad de veh√≠culos el√©ctricos esta elecci√≥n evoca limpieza, tecnolog√≠a y naturaleza ‚Äî estrategia frecuente de greenwashing visual.';
            } else if (pctCalido >= 60) {
                paletaClase = 'PALETA C√ÅLIDA';
                paletaColor = 'text-orange-700 bg-orange-50 border-orange-400';
                paletaDesc  = 'Predominan colores c√°lidos (rojos, naranjas, amarillos). Asociados a energ√≠a, dinamismo y estatus social. Sugiere un discurso orientado al deseo y al posicionamiento m√°s que a la sostenibilidad.';
            } else if (pctNeutro >= 60) {
                paletaClase = 'PALETA NEUTRA';
                paletaColor = 'text-gray-700 bg-gray-50 border-gray-400';
                paletaDesc  = 'Predominan tonos neutros (grises, blancos, negros, beige). Evoca sofisticaci√≥n, minimalismo y lujo. Puede ocultar estrategias de greenwashing bajo una apariencia de discreci√≥n y elegancia.';
            } else {
                paletaClase = 'PALETA MIXTA';
                paletaColor = 'text-purple-700 bg-purple-50 border-purple-400';
                paletaDesc  = 'Combinaci√≥n equilibrada de colores fr√≠os, c√°lidos y neutros. Puede indicar una estrategia multiobjetivo que mezcla discursos de estatus, libertad y sostenibilidad simult√°neamente.';
            }

            // Construir cuadrados de color (aprox. 19px ‚âà 5mm en pantalla a 96 dpi)
            const SQ = 19; // px ‚âà 5mm
            let swatchesHtml = '';
            classified.forEach(c => {
                const labelTipo = c.tipo === 'frio' ? '‚ùÑÔ∏è' : c.tipo === 'calido' ? 'üî•' : '‚¨ú';
                swatchesHtml += `
                    <div class="flex flex-col items-center">
                        <div title="${c.hex}" style="
                            width: ${SQ}px; height: ${SQ}px;
                            background-color: ${c.hex};
                            border: 1px solid rgba(0,0,0,0.15);
                            border-radius: 2px;
                            box-shadow: 0 1px 3px rgba(0,0,0,0.2);
                        "></div>
                        <span class="text-xs text-gray-500 mt-1" style="font-size:9px;">${c.hex}</span>
                        <span class="text-xs mt-0" style="font-size:9px;">${labelTipo}</span>
                    </div>
                `;
            });

            // Barra de proporci√≥n
            const barraHtml = `
                <div class="flex w-full rounded overflow-hidden h-3 mt-3 mb-1" style="max-width:300px;">
                    <div style="width:${pctFrio}%; background:#3b82f6;" title="Fr√≠os ${pctFrio}%"></div>
                    <div style="width:${pctCalido}%; background:#f97316;" title="C√°lidos ${pctCalido}%"></div>
                    <div style="width:${pctNeutro}%; background:#9ca3af;" title="Neutros ${pctNeutro}%"></div>
                </div>
                <div class="flex gap-4 text-xs text-gray-600">
                    <span><span class="inline-block w-3 h-3 rounded-sm bg-blue-400 mr-1"></span>Fr√≠os ${pctFrio}%</span>
                    <span><span class="inline-block w-3 h-3 rounded-sm bg-orange-400 mr-1"></span>C√°lidos ${pctCalido}%</span>
                    <span><span class="inline-block w-3 h-3 rounded-sm bg-gray-400 mr-1"></span>Neutros ${pctNeutro}%</span>
                </div>
            `;

            container.innerHTML = `
                <div class="space-y-5">

                    <!-- Cuadrados de colores dominantes -->
                    <div>
                        <p class="text-sm font-semibold text-gray-700 mb-3">5 colores dominantes (cuantizaci√≥n de color)</p>
                        <div class="flex gap-4 items-end flex-wrap">
                            ${swatchesHtml}
                        </div>
                    </div>

                    <!-- Barra de proporciones -->
                    <div>
                        <p class="text-sm font-semibold text-gray-700 mb-1">Proporci√≥n por temperatura de color</p>
                        ${barraHtml}
                    </div>

                    <!-- Clasificaci√≥n de la paleta -->
                    <div class="border-2 ${paletaColor} rounded-lg p-4">
                        <p class="text-xs text-gray-500 mb-1 font-medium uppercase tracking-wide">Clasificaci√≥n de la paleta</p>
                        <p class="text-2xl font-bold mb-2">${paletaClase}</p>
                        <p class="text-sm text-gray-700 leading-relaxed">${paletaDesc}</p>
                    </div>

                    <!-- Tabla detallada de colores -->
                    <div>
                        <p class="text-sm font-semibold text-gray-700 mb-2">Detalle colorim√©trico</p>
                        <table class="w-full text-sm">
                            <thead>
                                <tr class="bg-gray-100">
                                    <th class="p-2 text-left">#</th>
                                    <th class="p-2 text-left">Muestra</th>
                                    <th class="p-2 text-left">HEX</th>
                                    <th class="p-2 text-left">RGB</th>
                                    <th class="p-2 text-left">HSL</th>
                                    <th class="p-2 text-left">Temperatura</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${classified.map((c, i) => `
                                    <tr class="${i % 2 === 0 ? 'bg-white' : 'bg-gray-50'}">
                                        <td class="p-2 font-bold text-gray-400">${i + 1}</td>
                                        <td class="p-2">
                                            <div style="width:32px;height:18px;background:${c.hex};border:1px solid #e5e7eb;border-radius:3px;"></div>
                                        </td>
                                        <td class="p-2 font-mono font-semibold">${c.hex}</td>
                                        <td class="p-2 font-mono text-gray-600">rgb(${c.rgb.join(', ')})</td>
                                        <td class="p-2 font-mono text-gray-600">hsl(${c.hsl[0]}¬∞, ${c.hsl[1]}%, ${c.hsl[2]}%)</td>
                                        <td class="p-2">
                                            <span class="px-2 py-1 rounded-full text-xs font-bold ${
                                                c.tipo === 'frio'   ? 'bg-blue-100 text-blue-700'   :
                                                c.tipo === 'calido' ? 'bg-orange-100 text-orange-700' :
                                                                      'bg-gray-100 text-gray-600'
                                            }">
                                                ${c.tipo === 'frio' ? 'Fr√≠o' : c.tipo === 'calido' ? 'C√°lido' : 'Neutro'}
                                            </span>
                                        </td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>

                </div>
            `;
        }

        // ‚îÄ‚îÄ‚îÄ Helpers colorim√©tricos ‚îÄ‚îÄ‚îÄ
        function rgbToHex(r, g, b) {
            return '#' + [r, g, b].map(v => v.toString(16).padStart(2, '0')).join('').toUpperCase();
        }

        function rgbToHsl(r, g, b) {
            r /= 255; g /= 255; b /= 255;
            const max = Math.max(r, g, b), min = Math.min(r, g, b);
            let h, s, l = (max + min) / 2;
            if (max === min) {
                h = s = 0;
            } else {
                const d = max - min;
                s = l > 0.5 ? d / (2 - max - min) : d / (max + min);
                switch (max) {
                    case r: h = ((g - b) / d + (g < b ? 6 : 0)) / 6; break;
                    case g: h = ((b - r) / d + 2) / 6; break;
                    case b: h = ((r - g) / d + 4) / 6; break;
                }
            }
            return [Math.round(h * 360), Math.round(s * 100), Math.round(l * 100)];
        }

        function classifyColor(r, g, b) {
            const [h, s, l] = rgbToHsl(r, g, b);
            // Neutro: baja saturaci√≥n o muy claro/oscuro
            if (s < 15 || l < 10 || l > 90) return 'neutro';
            // Fr√≠o: azules (180-280), verdes (90-179), violetas (280-330)
            if ((h >= 90 && h <= 280)) return 'frio';
            // C√°lido: rojos, naranjas, amarillos (0-89 y 330-360)
            return 'calido';
        }

    </script>
</body>
</html>